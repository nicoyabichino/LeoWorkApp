<!DOCTYPE html>
<html lang="es">
<head>
    
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LR WorkApp</title>
    
    <link rel="manifest" href="manifest.json?v=14">
    <meta name="theme-color" content="#000000">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="LR WorkApp">

    <link rel="icon" type="image/png" href="icono.png">
    <link rel="apple-touch-icon" href="icono.png">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --bg: #000000; --card: #111111; --text: #f8fafc;
            --primary: #3b82f6; --success: #22c55e; --danger: #ef4444;
            --accent: #00d4ff; 
        }
        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; touch-action: manipulation; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); padding-bottom: 30px; overflow-x: hidden; }
        
        header { position: sticky; top: 0; background: #000; padding: 10px 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid var(--primary); z-index: 100; height: 60px; }
        .logo-header { height: 40px; width: 40px; object-fit: contain; border-radius: 6px; }
        
        .timer-val { font-family: monospace; font-size: 1.8rem; font-weight: bold; color: var(--success); }
        main { padding: 15px; max-width: 600px; margin: auto; min-height: 85vh; }
        
        #welcome-screen { text-align: center; padding: 40px 0; }
        .welcome-card { background: var(--card); border: 1px solid #333; padding: 30px; border-radius: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .logo-welcome { width: 100%; max-width: 280px; margin-bottom: 20px; }
        
        textarea { width: 100%; height: 120px; background: #000; color: #22c55e; border: 1px solid #333; border-radius: 12px; padding: 15px; margin: 15px 0; font-family: monospace; font-size: 0.9rem; outline: none; }
        .session-selector { width: 100%; padding: 12px; margin-bottom: 20px; background: #111; color: white; border: 1px solid var(--primary); border-radius: 8px; font-size: 1rem; }
        .exercise-card { background: var(--card); border-radius: 12px; margin-bottom: 20px; overflow: hidden; border: 1px solid #222; }
        .ex-header { padding: 15px; background: rgba(255,255,255,0.03); display: flex; justify-content: space-between; align-items: center; }
        
        .yt-icon { color: #ff0000; text-decoration: none; display: flex; align-items: center; gap: 4px; font-size: 0.75rem; font-weight: 900; border: 1px solid #ff0000; padding: 4px 8px; border-radius: 6px; background: rgba(255,0,0,0.1); }
        
        .grid-header { display: grid; grid-template-columns: 35px 1.2fr 1fr 1fr 0.8fr 45px; gap: 5px; padding: 10px; font-size: 0.65rem; color: #666; text-align: center; font-weight: bold; }
        .set-row { display: grid; grid-template-columns: 35px 1.2fr 1fr 1fr 0.8fr 45px; gap: 5px; padding: 8px 10px; align-items: center; border-top: 1px solid #222; }
        .obj-cell { font-size: 0.65rem; color: #eab308; background: #1a1300; padding: 4px; border-radius: 4px; text-align: center; line-height: 1.2; font-weight: bold; border: 1px solid #332200; }
        input { width: 100%; background: #000; border: 1px solid #333; color: white; padding: 10px 2px; border-radius: 5px; text-align: center; font-size: 1rem; outline: none; }
        .check-btn { width: 40px; height: 40px; border-radius: 50%; border: none; background: #222; color: white; cursor: pointer; font-size: 1.2rem; transition: 0.2s; }
        .check-btn.active { background: var(--success); transform: scale(1.1); }
        .set-row.done { background: rgba(34, 197, 94, 0.05); }
        .btn-stats { width: 100%; padding: 18px; background: var(--primary); color: white; border: none; border-radius: 12px; font-weight: bold; font-size: 1.1rem; margin-top: 10px; cursor: pointer; }
        
       .footer-sign { 
    text-align: center; 
    color: #444; 
    font-size: 0.7rem; 
    letter-spacing: 3px; 
    margin-top: 40px; 
    font-weight: bold; 
    padding-bottom: 100px; 
}

.footer-sign a {
    text-decoration: none;
}

.footer-sign span { 
    color: #00d4ff;
    text-shadow: 0 0 8px rgba(0, 212, 255, 0.6);
    transition: 0.3s;
}

.footer-sign span:hover {
    text-shadow: 0 0 15px rgba(0, 212, 255, 1);
    color: #ffffff;
}
        
        .custom-modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); z-index:10000; justify-content:center; align-items:center; }
        .modal-content { background:#161b22; width:85%; max-width:320px; padding:25px; border-radius:20px; border:1px solid #30363d; text-align:center; }
        
        #install-banner { display: none; position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: white; color: #000; padding: 18px 30px; border-radius: 50px; z-index: 9999; box-shadow: 0 10px 25px rgba(255,255,255,0.2); font-weight: 900; text-transform: uppercase; font-size: 0.8rem; width: 85%; text-align: center; border: none; }
        #hidden-canvases { position: absolute; left: -9999px; top: 0; visibility: hidden; }
/* Reemplaza o agrega esto en tu <style> */
#display.timer-val {
    position: sticky;
    top: 0; /* Se queda pegado al header */
    background: #000;
    z-index: 1000;
    text-align: center;
    padding: 10px 0;
    border-bottom: 1px solid #222;
    box-shadow: 0 4px 10px rgba(0,0,0,0.8);
    width: 100%;
}
        .btn-ghost {
    background: rgba(255, 255, 255, 0.05); /* Fondo casi transparente */
    color: #00d4ff;
    border: 1px solid rgba(255, 255, 255, 0.4); /* Borde suave */
    padding: 18px;
    border-radius: 15px;
    font-weight: bold;
    font-size: 0.9rem;
    letter-spacing: 1px;
    width: 100%;
    cursor: pointer;
    transition: all 0.3s ease;
    text-transform: uppercase;
    animation: pulse-ghost 2s infinite; /* Efecto de respiraci√≥n */
}

.btn-ghost:hover {
    background: rgba(255, 255, 255, 0.1);
    border-color: ##00d4ff;
    box-shadow: 0 0 15px rgba(255, 255, 255, 0.2);
}

@keyframes pulse-ghost {
    0% { box-shadow: 0 0 0 0 rgba(255, 255, 255, 0.1); }
    70% { box-shadow: 0 0 0 10px rgba(255, 255, 255, 0); }
    100% { box-shadow: 0 0 0 0 rgba(255, 255, 255, 0); }
}
    </style>
</head>
<body>

    <header>
        <img src="icono.png" alt="Icono Leo" class="logo-header">
        <div id="display" class="timer-val" style="display: none;">00:00</div>
        <div id="alumno-header" style="text-align: right; display: none;">
            <div id="alumno-display" style="font-size: 0.8rem; color: var(--primary); font-weight: bold;">-</div>
            <div id="semana-display" style="font-size: 0.9rem; color: #ffffff; font-weight: bold; margin-top: 2px;"></div>
        </div>
    </header>

    <main id="app-container">
        <div id="welcome-screen">
          <div id="welcome-screen">
    <div class="welcome-card">
        <img src="logo.png?v=2" alt="Leo Rodriguez Entrenamiento Personal" class="logo-welcome">
        
  <div id="install-required" style="display: none; padding: 10px;">
    <div style="font-size: 2.5rem; margin-bottom: 15px;">üì≤</div>
    
    <h3 style="color: #fff; font-size: 1.1rem; margin-bottom: 10px; letter-spacing: 1px;">
        MEJORA TU EXPERIENCIA
    </h3>
    
    <p style="font-size: 0.85rem; color: #888; margin-bottom: 25px; line-height: 1.5;">
        Instal√° la App para una mejor eficiencia.
    </p>

    <button class="btn-ghost" onclick="instalarApp()">
        Instalar Aplicaci√≥n
    </button>
</div>

        <div id="code-entry-area">
            <p style="font-size: 0.9rem; color: #888; margin-top: 10px;">COPI√Å EL C√ìDIGO DE RUTINA QUE TE ENVI√â</p>
            <textarea id="code-input" placeholder="Pega el c√≥digo aqu√≠..."></textarea>
            <button class="btn-stats" onclick="cargarManual()">EMPEZAR A ENTRENAR</button>
        </div>
    </div>
</div>
        </div>

        <div id="app-content" style="display:none;">
            <select id="session-picker" class="session-selector" onchange="loadSession(this.value)"></select>
            <div id="workout-content"></div>
            <button class="btn-stats" onclick="confirmarFinalizacion()">üìä GENERAR REPORTE SEMANAL</button>
            <button onclick="solicitarBorrar()" style="background:transparent; color:#444; border:none; width:100%; margin-top:40px; font-size:0.7rem; text-decoration:underline; letter-spacing: 1px;">BORRAR RUTINA ACTUAL</button>
        </div>
    </main>

    <div id="custom-confirm" class="custom-modal">
        <div class="modal-content">
            <h3 id="modal-title" style="color:white; margin-top:0; font-size:1.1rem;">¬øBorrar rutina?</h3>
            <p id="modal-text" style="color:#888; font-size:0.85rem; margin-bottom:25px;">Se eliminar√°n los pesos y series marcadas de esta semana.</p>
            <div style="display:flex; gap:10px;">
                <button id="modal-cancel-btn" onclick="cerrarConfirm(false)" style="flex:1; background:#30363d; color:white; border:none; padding:12px; border-radius:10px; font-weight:bold;">No</button>
                <button id="modal-confirm-btn" onclick="cerrarConfirm(true)" style="flex:1; background:var(--danger); color:white; border:none; padding:12px; border-radius:10px; font-weight:bold;">Confirmar</button>
            </div>
        </div>
    </div>

    <footer class="footer-sign">
    DESARROLLADO POR <a href="https://www.linkedin.com/in/nicolas-yabichino/" target="_blank"><span>NICOYABI</span></a>
</footer>

    <div id="hidden-canvases">
        <canvas id="chartMusculos" width="800" height="400"></canvas>
        <canvas id="chartSesiones" width="800" height="400"></canvas>
    </div>

<script>
    const audioSilencio = new Audio("data:audio/wav;base64,UklGRigAAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YQQAAAAAAA==");
    audioSilencio.loop = true;
    let rutinaFull = {}; let timerInt; let deferredPrompt;
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    let endTime;

    function playBeepFuerte() { 
        try { 
            let count = 0;
            const interval = setInterval(() => {
                const osc = audioCtx.createOscillator(); 
                const gain = audioCtx.createGain(); 
                osc.connect(gain); 
                gain.connect(audioCtx.destination); 
                osc.type = 'square';
                osc.frequency.setValueAtTime(1000, audioCtx.currentTime); 
                gain.gain.setValueAtTime(0.5, audioCtx.currentTime);
                osc.start(); 
                osc.stop(audioCtx.currentTime + 0.2); 
                count++;
                if (count >= 4) clearInterval(interval);
            }, 300);
        } catch(e) {} 
    }

    // --- L√ìGICA DE INICIO Y DETECCI√ìN DE CELULAR ---
    function init() {
        const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
        const isPWA = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;
        const dSaved = localStorage.getItem('routine_data_raw');

        // Si ya hay datos guardados, vamos directo a la rutina
        if (dSaved) {
            procesarDatos(dSaved);
            return;
        }

        // Si es m√≥vil y NO est√° abierta como PWA, obligamos a instalar
        if (isMobile && !isPWA) {
            document.getElementById('code-entry-area').style.display = 'none';
            document.getElementById('install-required').style.display = 'block';
        } else {
            // Si es PC o ya es PWA, mostramos el cargador de c√≥digo
            document.getElementById('code-entry-area').style.display = 'block';
            document.getElementById('install-required').style.display = 'none';
        }
    }

    // Capturar el evento de instalaci√≥n para Android/Chrome
    window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
    });

    async function instalarApp() {
        if (deferredPrompt) {
            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;
            if (outcome === 'accepted') {
                deferredPrompt = null;
                // No ocultamos el bot√≥n aqu√≠, dejamos que el usuario abra la app desde el icono
            }
        } else {
            // Caso iPhone o si el prompt no est√° disponible
            alert("Para instalar:\n1. Toca el bot√≥n 'Compartir' (cuadrado con flecha).\n2. Selecciona 'Agregar al inicio'.\n\nSi ya lo hiciste, abre la App desde tu pantalla de inicio.");
        }
    }

    // --- RESTO DE TUS FUNCIONES (Cargar, Marcar, Timer, Reporte) ---
    function cargarManual() { 
        let input = document.getElementById('code-input').value; 
        if (!input) return alert("Pega el c√≥digo"); 
        procesarDatos(input.includes('data=') ? input.split('data=')[1] : input); 
    }
    
    function procesarDatos(rawData) {
        try {
            rutinaFull = JSON.parse(decodeURIComponent(escape(atob(rawData.trim()))));
            localStorage.setItem('routine_data_raw', rawData);
            document.getElementById('alumno-display').innerText = rutinaFull.alumno;
            document.getElementById('semana-display').innerText = "SEMANA " + (rutinaFull.semana || "-");
            document.getElementById('session-picker').innerHTML = Object.keys(rutinaFull.sesiones).map(k => `<option value="${k}">${rutinaFull.sesiones[k].nombre}</option>`).join('');
            document.getElementById('welcome-screen').style.display = 'none';
            document.getElementById('app-content').style.display = 'block';
            document.getElementById('display').style.display = 'block';
            document.getElementById('alumno-header').style.display = 'block';
            loadSession(Object.keys(rutinaFull.sesiones)[0]);
        } catch (e) { alert("C√≥digo no v√°lido"); }
    }

    function loadSession(id) {
        const s = rutinaFull.sesiones[id];
        document.getElementById('workout-content').innerHTML = s.ejercicios.map((ex, exIdx) => {
            const rA = ex.reps_obj.split(',').map(x => x.trim());
            const pA = ex.peso_obj.split(',').map(x => x.trim());
            return `<div class="exercise-card">
                <div class="ex-header">
                    <div><strong>${ex.nombre}</strong><br><small style="color:var(--accent)">${ex.grupo}</small></div>
                    ${ex.video ? `<a href="${ex.video}" target="_blank" class="yt-icon">‚ñ∂ VIDEO</a>` : ''}
                </div>
                <div class="grid-header"><div>Set</div><div>Objetivo</div><div>Reps</div><div>Kg</div><div>RPE</div><div>Ok</div></div>
                ${Array.from({length: ex.series}).map((_, sIdx) => {
                    const saved = getSavedData(id, exIdx, sIdx);
                    const oR = rA[sIdx] || rA[rA.length-1] || ex.reps_obj;
                    const oK = pA[sIdx] || pA[pA.length-1] || ex.peso_obj;
                    return `<div class="set-row ${saved.done ? 'done' : ''}" id="row-${exIdx}-${sIdx}">
                        <div style="text-align:center;font-weight:bold;">${sIdx+1}</div>
                        <div class="obj-cell">Rep:${oR}<br>Kg:${oK}</div>
                        <div><input type="number" oninput="saveData('${id}',${exIdx},${sIdx})" value="${saved.reps || ''}" inputmode="numeric"></div>
                        <div><input type="number" oninput="saveData('${id}',${exIdx},${sIdx})" value="${saved.peso || ''}" inputmode="decimal"></div>
                        <div><input type="number" oninput="saveData('${id}',${exIdx},${sIdx})" value="${saved.rpe || ''}" inputmode="numeric"></div>
                        <div><button class="check-btn ${saved.done ? 'active' : ''}" onclick="markSet('${id}', ${exIdx}, ${sIdx}, ${ex.series})">‚úì</button></div>
                    </div>`;
                }).join('')}
            </div>`;
        }).join('');
    }

    function saveData(sessId, exIdx, sIdx) { 
        const row = document.getElementById(`row-${exIdx}-${sIdx}`); 
        const inputs = row.querySelectorAll('input'); 
        const done = row.querySelector('.check-btn').classList.contains('active'); 
        localStorage.setItem(`workout_${sessId}_${exIdx}_${sIdx}`, JSON.stringify({reps: inputs[0].value, peso: inputs[1].value, rpe: inputs[2].value, done: done})); 
    }
    
    function getSavedData(sessId, exIdx, sIdx) { 
        const saved = localStorage.getItem(`workout_${sessId}_${exIdx}_${sIdx}`); 
        return saved ? JSON.parse(saved) : { reps: '', peso: '', rpe: '', done: false }; 
    }

    function markSet(sessId, exIdx, sIdx, totalSets) { 
        const row = document.getElementById(`row-${exIdx}-${sIdx}`); 
        const btn = row.querySelector('.check-btn'); 
        row.classList.toggle('done'); 
        btn.classList.toggle('active'); 
        saveData(sessId, exIdx, sIdx); 
        if(row.classList.contains('done')) { 
            const isLast = (sIdx === totalSets - 1); 
            startTimer(isLast ? rutinaFull.sesiones[sessId].descanso_e : rutinaFull.sesiones[sessId].descanso_s); 
        } 
    }

    function startTimer(sec) { 
        clearInterval(timerInt); 
        const display = document.getElementById('display');
        audioSilencio.play().catch(e => console.log("Audio activo"));
        endTime = Date.now() + (sec * 1000); 
        timerInt = setInterval(() => { 
            const ahora = Date.now();
            const faltan = Math.round((endTime - ahora) / 1000);
            if(faltan <= 0) { 
                clearInterval(timerInt); 
                display.innerText = "00:00";
                playBeepFuerte(); 
                audioSilencio.pause();
                return;
            } 
            let m = Math.floor(faltan / 60); 
            let s = faltan % 60; 
            display.innerText = `${m}:${s.toString().padStart(2,'0')}`; 
        }, 1000); 
    }

    // L√≥gica de Modales y PDF... (Se mantiene igual a tu c√≥digo funcional)
    let modoModal = ""; 
    function solicitarBorrar() { modoModal = "BORRAR"; document.getElementById('modal-title').innerText = "¬øBorrar rutina?"; document.getElementById('modal-text').innerText = "Se eliminar√°n los pesos y series marcadas de esta semana."; document.getElementById('modal-confirm-btn').style.background = "var(--danger)"; document.getElementById('modal-confirm-btn').innerText = "Borrar"; document.getElementById('custom-confirm').style.display = 'flex'; }
    function confirmarFinalizacion() { modoModal = "REPORTE"; document.getElementById('modal-title').innerText = "Reporte Semanal"; document.getElementById('modal-text').innerText = "¬øDeseas generar el PDF?"; document.getElementById('modal-confirm-btn').style.background = "var(--success)"; document.getElementById('modal-confirm-btn').innerText = "Generar"; document.getElementById('custom-confirm').style.display = 'flex'; }
    function cerrarConfirm(aceptado) { document.getElementById('custom-confirm').style.display = 'none'; if(aceptado) { if(modoModal === "BORRAR") { localStorage.clear(); location.reload(); } else if(modoModal === "REPORTE") { generarReporteProfe(); } } }

    // Ejecutar inicializaci√≥n al cargar
    init();
</script>
</body>
</html>






