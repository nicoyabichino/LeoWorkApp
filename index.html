<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Leo Work App</title>
    
    <link rel="manifest" href="manifest.json?v=2">
    <meta name="theme-color" content="#000000">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --bg: #000000; --card: #111111; --text: #f8fafc;
            --primary: #3b82f6; --success: #22c55e; --danger: #ef4444;
            --accent: #00d4ff; /* Azul ElÃ©ctrico */
        }

        * { 
            box-sizing: border-box; margin: 0; padding: 0; 
            -webkit-tap-highlight-color: transparent; 
            touch-action: manipulation; 
        }

        body { 
            font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); 
            padding-bottom: 30px; overflow-x: hidden;
        }

        header { 
            position: sticky; top: 0; background: #000; padding: 15px; 
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 2px solid var(--primary); z-index: 100;
        }

        .logo { font-weight: bold; font-size: 1.2rem; }
        .timer-val { font-family: monospace; font-size: 1.8rem; font-weight: bold; color: var(--success); }
        
        main { padding: 15px; max-width: 600px; margin: auto; min-height: 85vh; }
        
        #welcome-screen { text-align: center; padding: 20px 0; }
        .welcome-card { background: var(--card); border: 1px solid #333; padding: 30px; border-radius: 20px; }
        .prof-title { color: #888; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 2px; margin-bottom: 5px; }
        .main-welcome-title { color: var(--primary); font-size: 1.8rem; margin-bottom: 15px; font-weight: 800; }
        
        textarea { 
            width: 100%; height: 150px; background: #000; color: #22c55e; border: 1px solid #333; 
            border-radius: 12px; padding: 15px; margin: 20px 0; font-family: monospace; font-size: 0.9rem; outline: none;
        }

        .session-selector { 
            width: 100%; padding: 12px; margin-bottom: 20px; 
            background: #111; color: white; border: 1px solid var(--primary); border-radius: 8px; font-size: 1rem;
        }
        
        .exercise-card { background: var(--card); border-radius: 12px; margin-bottom: 20px; overflow: hidden; border: 1px solid #222; }
        .ex-header { padding: 15px; background: rgba(255,255,255,0.03); display: flex; justify-content: space-between; align-items: center; }
        
        .grid-header { display: grid; grid-template-columns: 35px 1.2fr 1fr 1fr 0.8fr 45px; gap: 5px; padding: 10px; font-size: 0.65rem; color: #666; text-align: center; font-weight: bold; }
        .set-row { display: grid; grid-template-columns: 35px 1.2fr 1fr 1fr 0.8fr 45px; gap: 5px; padding: 8px 10px; align-items: center; border-top: 1px solid #222; }
        
        .obj-cell { font-size: 0.65rem; color: #eab308; background: #1a1300; padding: 4px; border-radius: 4px; text-align: center; line-height: 1.2; font-weight: bold; border: 1px solid #332200; }
        input { width: 100%; background: #000; border: 1px solid #333; color: white; padding: 10px 2px; border-radius: 5px; text-align: center; font-size: 1rem; outline: none; }
        
        .check-btn { width: 40px; height: 40px; border-radius: 50%; border: none; background: #222; color: white; cursor: pointer; font-size: 1.2rem; transition: 0.2s; }
        .check-btn.active { background: var(--success); transform: scale(1.1); }
        .set-row.done { background: rgba(34, 197, 94, 0.05); }

        .btn-stats { 
            width: 100%; padding: 18px; background: var(--primary); color: white; 
            border: none; border-radius: 12px; font-weight: bold; font-size: 1.1rem; margin-top: 10px; cursor: pointer;
        }

        .footer-sign { text-align: center; color: #888; font-size: 0.7rem; letter-spacing: 3px; margin-top: 40px; font-weight: bold; padding-bottom: 100px; }
        .brand-blue { color: var(--accent); text-shadow: 0 0 5px rgba(0, 212, 255, 0.3); }

        /* Banner de InstalaciÃ³n MÃ³vil del backup */
        #install-banner {
            display: none; position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); 
            background: var(--accent); color: #000; padding: 18px 30px; border-radius: 50px; 
            z-index: 9999; box-shadow: 0 10px 25px rgba(0,212,255,0.4); 
            font-weight: 900; text-transform: uppercase; font-size: 0.9rem; width: 85%; text-align: center; border: none;
        }

        #hidden-canvases { display: none; }
        .yt-icon { color: #ff0000; text-decoration: none; display: flex; align-items: center; gap: 4px; font-size: 0.7rem; font-weight: bold; }
    </style>
</head>
<body>

    <header>
        <div class="logo">LEO<span class="brand-blue">WorkApp</span></div>
        <div id="display" class="timer-val" style="display: none;">00:00</div>
        <div id="alumno-header" style="text-align: right; display: none;">
            <div id="alumno-display" style="font-size: 0.8rem; color: var(--primary); font-weight: bold;">-</div>
            <div id="semana-display" style="font-size: 0.6rem; color: #666;"></div>
        </div>
    </header>

    <main id="app-container">
        <div id="welcome-screen">
            <div class="welcome-card">
                <p class="prof-title">PROFESOR</p>
                <h1 class="main-welcome-title">LEONARDO <span class="brand-blue">RODRIGUEZ GARCIA</span></h1>
                <p style="font-size: 0.9rem; color: #ccc;">Pega el cÃ³digo que te enviÃ© para comenzar</p>
                <textarea id="code-input" placeholder="Pega el cÃ³digo aquÃ­..."></textarea>
                <button class="btn-stats" onclick="cargarManual()">EMPEZAR ENTRENAMIENTO</button>
            </div>
        </div>

        <div id="app-content" style="display:none;">
            <select id="session-picker" class="session-selector" onchange="loadSession(this.value)"></select>
            <div id="workout-content"></div>
            <button class="btn-stats" onclick="confirmarFinalizacion()">ðŸ“Š GENERAR REPORTE SEMANAL</button>
            <button onclick="borrarRutinaActual()" style="background:transparent; color:#555; border:none; width:100%; margin-top:30px; font-size:0.75rem; text-decoration:underline; cursor:pointer;">BORRAR Y CARGAR OTRA</button>
        </div>
    </main>

    <footer class="footer-sign">
        DESIGNED BY <span class="brand-blue">NICOYABICHINO</span>
    </footer>

    <button id="install-banner">ðŸ“² INSTALAR APP EN MI CELULAR</button>

    <div id="hidden-canvases"><canvas id="chartMusculos" width="800" height="400"></canvas><canvas id="chartSesiones" width="800" height="400"></canvas></div>

    <script>
        let rutinaFull = {}; let timerInt; let deferredPrompt;
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

        function playBeep() {
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain); gain.connect(audioCtx.destination);
            osc.type = 'sine'; osc.frequency.setValueAtTime(880, audioCtx.currentTime);
            gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
            osc.start(); osc.stop(audioCtx.currentTime + 0.3);
        }

        // LÃ³gica de PWA e InstalaciÃ³n del Backup
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./sw.js').catch(err => console.log(err));
        }

        const installBtn = document.getElementById('install-banner');
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault(); deferredPrompt = e;
            if (/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)) {
                installBtn.style.display = 'block';
            }
        });

        installBtn.addEventListener('click', async () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                if (outcome === 'accepted') installBtn.style.display = 'none';
                deferredPrompt = null;
            }
        });

        // Funcionalidad de la App
        function init() {
            let dSaved = localStorage.getItem('routine_data_raw');
            if (dSaved) procesarDatos(dSaved);
        }

        function cargarManual() {
            let input = document.getElementById('code-input').value;
            if (!input) return alert("Pega el cÃ³digo");
            procesarDatos(input.includes('data=') ? input.split('data=')[1] : input);
        }

        function procesarDatos(rawData) {
            try {
                rutinaFull = JSON.parse(decodeURIComponent(escape(atob(rawData.trim()))));
                localStorage.setItem('routine_data_raw', rawData);
                document.getElementById('alumno-display').innerText = rutinaFull.alumno;
                document.getElementById('semana-display').innerText = "SEMANA " + (rutinaFull.semana || "-");
                document.getElementById('session-picker').innerHTML = Object.keys(rutinaFull.sesiones).map(k => `<option value="${k}">${rutinaFull.sesiones[k].nombre}</option>`).join('');
                
                document.getElementById('welcome-screen').style.display = 'none';
                document.getElementById('app-content').style.display = 'block';
                document.getElementById('display').style.display = 'block';
                document.getElementById('alumno-header').style.display = 'block';
                
                loadSession(Object.keys(rutinaFull.sesiones)[0]);
            } catch (e) { alert("CÃ³digo no vÃ¡lido"); }
        }

        function loadSession(id) {
            const s = rutinaFull.sesiones[id];
            document.getElementById('workout-content').innerHTML = s.ejercicios.map((ex, exIdx) => {
                const rA = ex.reps_obj.split(',').map(x => x.trim());
                const pA = ex.peso_obj.split(',').map(x => x.trim());
                return `<div class="exercise-card">
                    <div class="ex-header">
                        <div><strong>${ex.nombre}</strong><br><small style="color:var(--accent)">${ex.grupo}</small></div>
                        ${ex.video ? `<a href="${ex.video}" target="_blank" class="yt-icon"><svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M8.051 1.999h.089c.822.003 4.987.033 6.11.335a2.01 2.01 0 0 1 1.415 1.42c.101.38.172.883.22 1.402l.01.104.022.26.008.104c.065.914.073 1.77.074 1.957v.075c-.001.194-.01 1.108-.082 2.06l-.008.105-.009.104c-.05.572-.124 1.14-.235 1.558a2.007 2.007 0 0 1-1.415 1.42c-1.16.312-5.569.334-6.18.335h-.142c-.309 0-1.587-.006-2.927-.052l-.17-.006-.087-.004-.171-.007-.171-.007c-1.11-.049-2.167-.128-2.654-.26a2.007 2.007 0 0 1-1.415-1.419c-.111-.417-.185-.986-.235-1.558L.09 9.82l-.008-.104A31.4 31.4 0 0 1 0 7.68v-.123c.002-.215.01-.958.064-1.778l.007-.103.003-.052.008-.104.022-.26.01-.104c.048-.519.119-1.023.22-1.402a2.007 2.007 0 0 1 1.415-1.42c.487-.13 1.544-.21 2.654-.26l.17-.007.172-.006.086-.003.171-.007A99.788 99.788 0 0 1 7.858 2h.193zM6.4 5.209v4.818l4.157-2.408L6.4 5.209z"/></svg> VIDEO</a>` : ''}
                    </div>
                    <div class="grid-header"><div>Set</div><div>Objetivo</div><div>Reps</div><div>Kg</div><div>RPE</div><div>Ok</div></div>
                    ${Array.from({length: ex.series}).map((_, sIdx) => {
                        const saved = getSavedData(id, exIdx, sIdx);
                        const oR = rA[sIdx] || rA[rA.length-1] || ex.reps_obj;
                        const oK = pA[sIdx] || pA[pA.length-1] || ex.peso_obj;
                        return `<div class="set-row ${saved.done ? 'done' : ''}" id="row-${exIdx}-${sIdx}">
                            <div style="text-align:center;font-weight:bold;">${sIdx+1}</div>
                            <div class="obj-cell">Rep:${oR}<br>Kg:${oK}</div>
                            <div><input type="number" oninput="saveData('${id}',${exIdx},${sIdx})" value="${saved.reps || ''}" inputmode="numeric"></div>
                            <div><input type="number" oninput="saveData('${id}',${exIdx},${sIdx})" value="${saved.peso || ''}" inputmode="decimal"></div>
                            <div><input type="number" oninput="saveData('${id}',${exIdx},${sIdx})" value="${saved.rpe || ''}" inputmode="numeric"></div>
                            <div><button class="check-btn ${saved.done ? 'active' : ''}" onclick="markSet('${id}', ${exIdx}, ${sIdx}, ${ex.series})">âœ“</button></div>
                        </div>`;
                    }).join('')}
                </div>`;
            }).join('');
        }

        function saveData(sessId, exIdx, sIdx) {
            const row = document.getElementById(`row-${exIdx}-${sIdx}`);
            const inputs = row.querySelectorAll('input');
            const done = row.querySelector('.check-btn').classList.contains('active');
            localStorage.setItem(`workout_${sessId}_${exIdx}_${sIdx}`, JSON.stringify({reps: inputs[0].value, peso: inputs[1].value, rpe: inputs[2].value, done: done}));
        }

        function getSavedData(sessId, exIdx, sIdx) {
            const saved = localStorage.getItem(`workout_${sessId}_${exIdx}_${sIdx}`);
            return saved ? JSON.parse(saved) : { reps: '', peso: '', rpe: '', done: false };
        }

        function markSet(sessId, exIdx, sIdx, totalSets) {
            const row = document.getElementById(`row-${exIdx}-${sIdx}`);
            const btn = row.querySelector('.check-btn');
            row.classList.toggle('done'); btn.classList.toggle('active');
            saveData(sessId, exIdx, sIdx);
            if(row.classList.contains('done')) {
                const isLast = (sIdx === totalSets - 1);
                startTimer(isLast ? rutinaFull.sesiones[sessId].descanso_e : rutinaFull.sesiones[sessId].descanso_s);
            }
        }

        function startTimer(sec) {
            clearInterval(timerInt); let t = sec;
            timerInt = setInterval(() => {
                let m = Math.floor(t/60); let s = t%60;
                document.getElementById('display').innerText = `${m}:${s.toString().padStart(2,'0')}`;
                if(t <= 0) { clearInterval(timerInt); playBeep(); }
                t--;
            }, 1000);
        }

        function borrarRutinaActual() { if(confirm("Â¿Borrar rutina?")) { localStorage.clear(); location.reload(); } }

        // LÃ³gica de PDF y GrÃ¡ficos (igual a la anterior)
        async function crearImgGrafico(canvasId, labels, data, maxVal, datasetLabel) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            const chart = new Chart(ctx, {
                type: 'bar', data: { labels: labels, datasets: [{ label: datasetLabel, data: data, backgroundColor: '#3b82f6', borderRadius: 5 }] },
                options: { animation: false, plugins: { legend: { display: true, labels: { color: 'white' } } }, scales: { y: { beginAtZero: true, suggestedMax: maxVal, ticks: { color: 'white' }, grid: { color: '#333' } }, x: { ticks: { color: 'white', font: { size: 10 } }, grid: { display: false } } } }
            });
            await new Promise(r => setTimeout(r, 300)); const url = document.getElementById(canvasId).toDataURL('image/png'); chart.destroy(); return url;
        }

        // FunciÃ³n para capturar los datos y generar el PDF
async function generarReporteProfe() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('p', 'mm', 'a4');
    
    let conteoMusculos = {};
    let conteoSesiones = {};

    // 1. Recopilar datos de lo que el alumno marcÃ³ como "hecho"
    Object.keys(rutinaFull.sesiones).forEach(sId => {
        let totalSeriesSesion = 0;
        rutinaFull.sesiones[sId].ejercicios.forEach((ex, exIdx) => {
            for(let sIdx=0; sIdx < ex.series; sIdx++) {
                const saved = getSavedData(sId, exIdx, sIdx);
                if(saved.done) {
                    const grupo = ex.grupo.toUpperCase();
                    conteoMusculos[grupo] = (conteoMusculos[grupo] || 0) + 1;
                    totalSeriesSesion++;
                }
            }
        });
        if(totalSeriesSesion > 0) {
            conteoSesiones[rutinaFull.sesiones[sId].nombre] = totalSeriesSesion;
        }
    });

    if (Object.keys(conteoMusculos).length === 0) {
        return alert("Primero debes marcar algunos sets como completados (âœ“) para generar un reporte.");
    }

    // 2. ConfiguraciÃ³n estÃ©tica del PDF (Fondo Negro)
    doc.setFillColor(0, 0, 0);
    doc.rect(0, 0, 210, 297, 'F');
    
    doc.setTextColor(0, 212, 255); // Azul ElÃ©ctrico
    doc.setFontSize(22);
    doc.text("REPORTE DE ENTRENAMIENTO", 105, 25, { align: 'center' });
    
    doc.setTextColor(255, 255, 255);
    doc.setFontSize(14);
    doc.text(`Alumno: ${rutinaFull.alumno}`, 20, 40);
    doc.text(`Semana: ${rutinaFull.semana || "-"}`, 20, 48);

    // 3. Crear y agregar GrÃ¡fico de MÃºsculos
    doc.setFontSize(12);
    doc.text("VOLUMEN POR GRUPO MUSCULAR (Series)", 20, 65);
    const imgMusculos = await crearImgGrafico(
        'chartMusculos', 
        Object.keys(conteoMusculos), 
        Object.values(conteoMusculos), 
        'Series Totales'
    );
    doc.addImage(imgMusculos, 'PNG', 15, 70, 180, 80);

    // 4. Crear y agregar GrÃ¡fico de Sesiones
    doc.text("INTENSIDAD POR SESIÃ“N (Series completadas)", 20, 165);
    const imgSesiones = await crearImgGrafico(
        'chartSesiones', 
        Object.keys(conteoSesiones), 
        Object.values(conteoSesiones), 
        'Sets'
    );
    doc.addImage(imgSesiones, 'PNG', 15, 170, 180, 80);

    // 5. Firma decorativa
    doc.setTextColor(100, 100, 100);
    doc.setFontSize(8);
    doc.text("DESIGNED BY NICOYABICHINO - LEO WORKAPP PRO", 105, 285, { align: 'center' });

    // Descargar
    doc.save(`Reporte_Semana${rutinaFull.semana}_${rutinaFull.alumno}.pdf`);
}

// FunciÃ³n auxiliar para renderizar el grÃ¡fico en un canvas oculto y pasarlo a imagen
async function crearImgGrafico(canvasId, labels, data, datasetLabel) {
    const canvas = document.getElementById(canvasId);
    const ctx = canvas.getContext('2d');
    
    const chart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: datasetLabel,
                data: data,
                backgroundColor: '#3b82f6',
                borderColor: '#00d4ff',
                borderWidth: 1
            }]
        },
        options: {
            devicePixelRatio: 2, // Mejor resoluciÃ³n para el PDF
            animation: false,
            scales: {
                y: { beginAtZero: true, ticks: { color: 'white' } },
                x: { ticks: { color: 'white' } }
            },
            plugins: {
                legend: { labels: { color: 'white' } }
            }
        }
    });

    // Esperar a que se renderice el frame
    await new Promise(r => setTimeout(r, 500));
    const url = canvas.toDataURL('image/png');
    chart.destroy();
    return url;
}
    </script>
</body>
</html>



