<!DOCTYPE html>
<html lang="es">
<head>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Workout Player Pro - Alumno</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        :root {
            --bg: #000000; --card: #111111; --text: #f8fafc;
            --primary: #3b82f6; --success: #22c55e; --danger: #ef4444;
            --accent: #00d4ff; 
        }
        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); padding-bottom: 30px; touch-action: manipulation; }
        header { position: sticky; top: 0; background: #000; padding: 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid var(--primary); z-index: 100; }
        .timer-val { font-family: monospace; font-size: 2.2rem; font-weight: bold; color: var(--success); }
        main { padding: 15px; max-width: 600px; margin: auto; min-height: 85vh; }
        #welcome-screen { text-align: center; padding: 20px 0; }
        .welcome-card { background: var(--card); border: 1px solid #333; padding: 30px; border-radius: 20px; }
        .prof-title { color: #888; font-size: 0.8rem; text-transform: uppercase; letter-spacing: 2px; margin-bottom: 5px; }
        .main-welcome-title { color: var(--primary); font-size: 1.6rem; margin-bottom: 15px; }
        textarea { width: 100%; height: 150px; background: #000; color: #22c55e; border: 1px solid #333; border-radius: 12px; padding: 15px; margin: 20px 0; font-family: monospace; font-size: 0.9rem; outline: none; }
        .session-selector { width: 100%; padding: 12px; margin-bottom: 20px; background: #111; color: white; border: 1px solid var(--primary); border-radius: 8px; font-size: 1rem; }
        .exercise-card { background: var(--card); border-radius: 12px; margin-bottom: 20px; overflow: hidden; border: 1px solid #222; }
        .ex-header { padding: 15px; background: rgba(255,255,255,0.03); display: flex; justify-content: space-between; align-items: center; }
        .grid-header { display: grid; grid-template-columns: 35px 1.2fr 1fr 1fr 0.8fr 45px; gap: 5px; padding: 10px; font-size: 0.65rem; color: #666; text-align: center; font-weight: bold; }
        .set-row { display: grid; grid-template-columns: 35px 1.2fr 1fr 1fr 0.8fr 45px; gap: 5px; padding: 8px 10px; align-items: center; border-top: 1px solid #222; }
        .obj-cell { font-size: 0.65rem; color: #eab308; background: #1a1300; padding: 4px; border-radius: 4px; text-align: center; line-height: 1.2; font-weight: bold; border: 1px solid #332200; }
        input { width: 100%; background: #000; border: 1px solid #333; color: white; padding: 10px 2px; border-radius: 5px; text-align: center; font-size: 1rem; outline: none; }
        .check-btn { width: 40px; height: 40px; border-radius: 50%; border: none; background: #222; color: white; cursor: pointer; font-size: 1.2rem; }
        .check-btn.active { background: var(--success); }
        .set-row.done { background: rgba(34, 197, 94, 0.1); }
        .btn-stats { width: 100%; padding: 18px; background: var(--primary); color: white; border: none; border-radius: 12px; font-weight: bold; font-size: 1.1rem; margin-top: 10px; cursor: pointer; }
        .footer-sign { text-align: center; color: #888; font-size: 0.7rem; letter-spacing: 3px; margin-top: 40px; font-weight: bold; }
        .brand-link { color: var(--accent); text-decoration: none; }
        #hidden-canvases { display: none; }
    </style>
</head>
<body>

<header id="app-header" style="display:none;">
    <div>
        <p id="timer-label" style="font-size: 0.7rem; color: #666;">ENTRENANDO</p>
        <div id="display" class="timer-val">00:00</div>
    </div>
    <div style="text-align: right;">
        <h2 id="alumno-display" style="font-size: 1rem; color: var(--primary); margin:0;">-</h2>
        <small id="semana-display" style="color:#666; font-size: 0.7rem;"></small>
    </div>
</header>

<main>
    <div id="welcome-screen">
        <p class="prof-title">Prof. Leonardo Rodriguez Garcia</p>
        <div class="welcome-card">
            <h2 class="main-welcome-title">Â¡Bienvenido Alumno!</h2>
            <p style="font-size:0.9rem; color:#888;">Pega aquÃ­ el cÃ³digo de rutina que te enviÃ©:</p>
            <textarea id="manual-data" placeholder="Pega el cÃ³digo aquÃ­..."></textarea>
            <button class="btn-stats" onclick="cargarManual()">INICIAR ENTRENAMIENTO</button>
        </div>
    </div>

    <div id="app-content" style="display:none;">
        <select id="session-picker" class="session-selector" onchange="loadSession(this.value)"></select>
        <div id="workout-content"></div>
        <button class="btn-stats" onclick="confirmarFinalizacion()">ðŸ“Š GENERAR REPORTE SEMANAL</button>
        <button onclick="borrarRutinaActual()" style="background:transparent; color:#555; border:none; width:100%; margin-top:30px; font-size:0.75rem; text-decoration:underline; cursor:pointer; font-weight:bold;">BORRAR RUTINA Y CARGAR OTRA</button>
    </div>

    <button id="btn-instalar" style="display:none; width:100%; padding:15px; background: #ffffff; color: #000; border: none; border-radius: 12px; font-weight: bold; margin-top: 20px; cursor: pointer; align-items: center; justify-content: center; gap: 10px;">
        ðŸ“² INSTALAR APP EN MI CELULAR
    </button>

    <div class="footer-sign">
        CREADO POR <a href="https://www.linkedin.com/in/nicolas-yabichino/" target="_blank" class="brand-link">NICOYABI</a>
    </div>
</main>

<div id="hidden-canvases"><canvas id="chartMusculos" width="800" height="400"></canvas><canvas id="chartSesiones" width="800" height="400"></canvas></div>

<script>
    let rutinaFull = {}; 
    let timerInt;
    let deferredPrompt; // Declarada una sola vez

    // Registro de Service Worker
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('sw.js').catch(err => console.log("Error SW:", err));
    }

    function init() {
        let dURL = new URLSearchParams(window.location.search).get('data');
        let dSaved = localStorage.getItem('routine_data_raw');
        if (dURL) procesarDatos(dURL); else if (dSaved) procesarDatos(dSaved);
    }

    function cargarManual() {
        let input = document.getElementById('manual-data').value;
        if (!input) return alert("Pega el cÃ³digo");
        procesarDatos(input.includes('data=') ? input.split('data=')[1] : input);
    }

    function procesarDatos(rawData) {
        try {
            rutinaFull = JSON.parse(decodeURIComponent(escape(atob(rawData.trim()))));
            localStorage.setItem('routine_data_raw', rawData);
            document.getElementById('alumno-display').innerText = rutinaFull.alumno;
            document.getElementById('semana-display').innerText = "SEMANA #" + (rutinaFull.semana || "-");
            document.getElementById('session-picker').innerHTML = Object.keys(rutinaFull.sesiones).map(k => `<option value="${k}">${rutinaFull.sesiones[k].nombre}</option>`).join('');
            document.getElementById('welcome-screen').style.display = 'none';
            document.getElementById('app-header').style.display = 'flex';
            document.getElementById('app-content').style.display = 'block';
            loadSession(Object.keys(rutinaFull.sesiones)[0]);
        } catch (e) { alert("CÃ³digo no vÃ¡lido"); }
    }

    function loadSession(id) {
        const s = rutinaFull.sesiones[id];
        document.getElementById('workout-content').innerHTML = s.ejercicios.map((ex, exIdx) => {
            const rA = ex.reps_obj.split(',').map(x => x.trim());
            const pA = ex.peso_obj.split(',').map(x => x.trim());
            return `<div class="exercise-card">
                <div class="ex-header">
                    <div><strong>${ex.nombre}</strong><br><small style="color:var(--primary)">${ex.grupo}</small></div>
                    ${ex.video ? `<a href="${ex.video}" target="_blank" style="color:#FF0000;text-decoration:none;font-weight:bold;">VIDEO</a>` : ''}
                </div>
                <div class="grid-header"><div>Set</div><div>Objetivo</div><div>Reps</div><div>Kg</div><div>RPE</div><div>Ok</div></div>
                ${Array.from({length: ex.series}).map((_, sIdx) => {
                    const saved = getSavedData(id, exIdx, sIdx);
                    const oR = rA[sIdx] || rA[rA.length-1] || ex.reps_obj;
                    const oK = pA[sIdx] || pA[pA.length-1] || ex.peso_obj;
                    return `<div class="set-row ${saved.done ? 'done' : ''}" id="row-${exIdx}-${sIdx}">
                        <div style="text-align:center;font-weight:bold;">${sIdx+1}</div>
                        <div class="obj-cell">R:${oR}<br>K:${oK}</div>
                        <div><input type="number" oninput="saveData('${id}',${exIdx},${sIdx})" value="${saved.reps || ''}" inputmode="numeric"></div>
                        <div><input type="number" oninput="saveData('${id}',${exIdx},${sIdx})" value="${saved.peso || ''}" inputmode="decimal"></div>
                        <div><input type="number" oninput="saveData('${id}',${exIdx},${sIdx})" value="${saved.rpe || ''}" inputmode="numeric"></div>
                        <div><button class="check-btn ${saved.done ? 'active' : ''}" onclick="markSet('${id}', ${exIdx}, ${sIdx}, ${ex.series})">âœ“</button></div>
                    </div>`;
                }).join('')}
            </div>`;
        }).join('');
    }

    function saveData(sessId, exIdx, sIdx) {
        const row = document.getElementById(`row-${exIdx}-${sIdx}`);
        const inputs = row.querySelectorAll('input');
        const done = row.querySelector('.check-btn').classList.contains('active');
        localStorage.setItem(`workout_${sessId}_${exIdx}_${sIdx}`, JSON.stringify({reps: inputs[0].value, peso: inputs[1].value, rpe: inputs[2].value, done: done}));
    }

    function getSavedData(sessId, exIdx, sIdx) {
        const saved = localStorage.getItem(`workout_${sessId}_${exIdx}_${sIdx}`);
        return saved ? JSON.parse(saved) : { reps: '', peso: '', rpe: '', done: false };
    }

    function markSet(sessId, exIdx, sIdx, totalSets) {
        const row = document.getElementById(`row-${exIdx}-${sIdx}`);
        const btn = row.querySelector('.check-btn');
        row.classList.toggle('done'); btn.classList.toggle('active');
        saveData(sessId, exIdx, sIdx);
        if(row.classList.contains('done')) {
            const isLast = (sIdx === totalSets - 1);
            startTimer(isLast ? rutinaFull.sesiones[sessId].descanso_e : rutinaFull.sesiones[sessId].descanso_s, isLast ? "CAMBIO" : "SERIE");
        }
    }

    function startTimer(sec, label) {
        clearInterval(timerInt); let t = sec;
        timerInt = setInterval(() => {
            let m = Math.floor(t/60); let s = t%60;
            document.getElementById('display').innerText = `${m}:${s.toString().padStart(2,'0')}`;
            document.getElementById('timer-label').innerText = label;
            if(t <= 0) clearInterval(timerInt); t--;
        }, 1000);
    }

    function borrarRutinaActual() { if(confirm("Â¿Borrar rutina?")) { localStorage.clear(); location.reload(); } }

    async function crearImgGrafico(canvasId, labels, data, maxVal, datasetLabel) {
        const ctx = document.getElementById(canvasId).getContext('2d');
        const chart = new Chart(ctx, {
            type: 'bar', data: { labels: labels, datasets: [{ label: datasetLabel, data: data, backgroundColor: '#3b82f6', borderRadius: 5 }] },
            options: { animation: false, plugins: { legend: { display: true, labels: { color: 'white' } } }, scales: { y: { beginAtZero: true, suggestedMax: maxVal, ticks: { color: 'white' }, grid: { color: '#333' } }, x: { ticks: { color: 'white', font: { size: 10 } }, grid: { display: false } } } },
            plugins: [{ id: 'valueLabel', afterDatasetsDraw(chart) { const {ctx} = chart; ctx.save(); ctx.textAlign = 'center'; ctx.fillStyle = 'white'; ctx.font = 'bold 12px Arial'; chart.getDatasetMeta(0).data.forEach((bar, i) => { ctx.fillText(chart.data.datasets[0].data[i], bar.x, bar.y - 5); }); ctx.restore(); } }]
        });
        await new Promise(r => setTimeout(r, 300)); const url = document.getElementById(canvasId).toDataURL('image/png'); chart.destroy(); return url;
    }

    async function generarReporteProfe() {
        const { jsPDF } = window.jspdf; const doc = new jsPDF('p', 'mm', 'a4'); let cM = {}, cS = {};
        Object.keys(rutinaFull.sesiones).forEach(sId => {
            let tS = 0; rutinaFull.sesiones[sId].ejercicios.forEach((ex, exIdx) => {
                for(let sIdx=0; sIdx < ex.series; sIdx++) { const saved = getSavedData(sId, exIdx, sIdx); if(saved.done) { const m = ex.grupo.toUpperCase(); cM[m] = (cM[m] || 0) + 1; tS++; } }
            }); cS[rutinaFull.sesiones[sId].nombre] = tS;
        });
        doc.setFillColor(0, 0, 0); doc.rect(0, 0, 210, 297, 'F'); doc.setTextColor(255, 255, 255); doc.setFontSize(22); doc.text(`REPORTE SEMANA ${rutinaFull.semana || "-"}`, 105, 20, { align: 'center' });
        doc.setTextColor(59, 130, 246); doc.text(`ALUMNO: ${rutinaFull.alumno.toUpperCase()}`, 105, 30, { align: 'center' });
        const i1 = await crearImgGrafico('chartMusculos', Object.keys(cM), Object.values(cM), 20, 'Series'); doc.addImage(i1, 'PNG', 15, 50, 180, 75);
        const i2 = await crearImgGrafico('chartSesiones', Object.keys(cS), Object.values(cS), 30, 'Series Totales'); doc.addImage(i2, 'PNG', 15, 140, 180, 75);
        let body = []; Object.keys(rutinaFull.sesiones).forEach(sId => { rutinaFull.sesiones[sId].ejercicios.forEach((ex, exIdx) => { for(let sIdx=0; sIdx < ex.series; sIdx++) { const saved = getSavedData(sId, exIdx, sIdx); if(saved.done) body.push([ex.nombre, `S${sIdx+1}`, saved.reps, saved.peso, saved.rpe]); } }); });
        doc.autoTable({ startY: 230, head: [['EJERCICIO', 'SET', 'REPS', 'KG', 'RPE']], body: body, theme: 'grid', styles: { fillColor: [15, 15, 15], textColor: 255, fontSize: 8 }, headStyles: { fillColor: [59, 130, 246] } });
        doc.save(`Reporte_${rutinaFull.alumno}_Semana${rutinaFull.semana}.pdf`);
    }

    function confirmarFinalizacion() { if(confirm("Â¿Generar reporte?")) generarReporteProfe(); }

    // --- LÃ“GICA DE INSTALACIÃ“N CORREGIDA ---
    const btnInstalar = document.getElementById('btn-instalar');
    const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);

    window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
        if (isMobile) {
            btnInstalar.style.display = 'flex';
        }
    });

    btnInstalar.addEventListener('click', async () => {
        if (deferredPrompt) {
            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;
            deferredPrompt = null;
            btnInstalar.style.display = 'none';
        }
    });

    window.addEventListener('appinstalled', () => {
        btnInstalar.style.display = 'none';
        deferredPrompt = null;
    });

    init();
</script>
</body>
</html>












