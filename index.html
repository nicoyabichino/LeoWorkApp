<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LR WorkApp</title>
    
    <link rel="manifest" href="manifest.json?v=6">
    <meta name="theme-color" content="#000000">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="LR WorkApp">

    <link rel="icon" type="image/png" href="icono.png">
    <link rel="apple-touch-icon" href="icono.png">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --bg: #000000; --card: #111111; --text: #f8fafc;
            --primary: #3b82f6; --success: #22c55e; --danger: #ef4444;
            --accent: #00d4ff; 
        }
        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; touch-action: manipulation; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); padding-bottom: 30px; overflow-x: hidden; }
        
        header { position: sticky; top: 0; background: #000; padding: 10px 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid var(--primary); z-index: 100; height: 60px; }
        .logo-header { height: 40px; width: 40px; object-fit: contain; border-radius: 6px; }
        
        .timer-val { font-family: monospace; font-size: 1.8rem; font-weight: bold; color: var(--success); }
        main { padding: 15px; max-width: 600px; margin: auto; min-height: 85vh; }
        
        #welcome-screen { text-align: center; padding: 40px 0; }
        .welcome-card { background: var(--card); border: 1px solid #333; padding: 30px; border-radius: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .logo-welcome { width: 100%; max-width: 280px; margin-bottom: 20px; }
        
        textarea { width: 100%; height: 120px; background: #000; color: #22c55e; border: 1px solid #333; border-radius: 12px; padding: 15px; margin: 15px 0; font-family: monospace; font-size: 0.9rem; outline: none; }
        .session-selector { width: 100%; padding: 12px; margin-bottom: 20px; background: #111; color: white; border: 1px solid var(--primary); border-radius: 8px; font-size: 1rem; }
        .exercise-card { background: var(--card); border-radius: 12px; margin-bottom: 20px; overflow: hidden; border: 1px solid #222; }
        .ex-header { padding: 15px; background: rgba(255,255,255,0.03); display: flex; justify-content: space-between; align-items: center; }
        
        .yt-icon { color: #ff0000; text-decoration: none; display: flex; align-items: center; gap: 4px; font-size: 0.75rem; font-weight: 900; border: 1px solid #ff0000; padding: 4px 8px; border-radius: 6px; background: rgba(255,0,0,0.1); }
        
        .grid-header { display: grid; grid-template-columns: 35px 1.2fr 1fr 1fr 0.8fr 45px; gap: 5px; padding: 10px; font-size: 0.65rem; color: #666; text-align: center; font-weight: bold; }
        .set-row { display: grid; grid-template-columns: 35px 1.2fr 1fr 1fr 0.8fr 45px; gap: 5px; padding: 8px 10px; align-items: center; border-top: 1px solid #222; }
        .obj-cell { font-size: 0.65rem; color: #eab308; background: #1a1300; padding: 4px; border-radius: 4px; text-align: center; line-height: 1.2; font-weight: bold; border: 1px solid #332200; }
        input { width: 100%; background: #000; border: 1px solid #333; color: white; padding: 10px 2px; border-radius: 5px; text-align: center; font-size: 1rem; outline: none; }
        .check-btn { width: 40px; height: 40px; border-radius: 50%; border: none; background: #222; color: white; cursor: pointer; font-size: 1.2rem; transition: 0.2s; }
        .check-btn.active { background: var(--success); transform: scale(1.1); }
        .set-row.done { background: rgba(34, 197, 94, 0.05); }
        .btn-stats { width: 100%; padding: 18px; background: var(--primary); color: white; border: none; border-radius: 12px; font-weight: bold; font-size: 1.1rem; margin-top: 10px; cursor: pointer; }
        
       .footer-sign { 
    text-align: center; 
    color: #444; 
    font-size: 0.7rem; 
    letter-spacing: 3px; 
    margin-top: 40px; 
    font-weight: bold; 
    padding-bottom: 100px; 
}

.footer-sign a {
    text-decoration: none;
}

.footer-sign span { 
    color: #00d4ff;
    text-shadow: 0 0 8px rgba(0, 212, 255, 0.6);
    transition: 0.3s;
}

.footer-sign span:hover {
    text-shadow: 0 0 15px rgba(0, 212, 255, 1);
    color: #ffffff;
}
        
        .custom-modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); z-index:10000; justify-content:center; align-items:center; }
        .modal-content { background:#161b22; width:85%; max-width:320px; padding:25px; border-radius:20px; border:1px solid #30363d; text-align:center; }
        
        #install-banner { display: none; position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: white; color: #000; padding: 18px 30px; border-radius: 50px; z-index: 9999; box-shadow: 0 10px 25px rgba(255,255,255,0.2); font-weight: 900; text-transform: uppercase; font-size: 0.8rem; width: 85%; text-align: center; border: none; }
        #hidden-canvases { position: absolute; left: -9999px; top: 0; visibility: hidden; }
/* Bot√≥n de indicaciones s√∫per llamativo */
.info-btn {
    background: var(--accent); /* Azul El√©ctrico */
    color: #000; /* Texto negro para contraste */
    border: none;
    border-radius: 6px;
    padding: 4px 10px;
    font-size: 0.7rem;
    font-weight: 900;
    cursor: pointer;
    margin-left: 10px;
    letter-spacing: 1px;
    box-shadow: 0 0 10px rgba(0, 212, 255, 0.4);
    animation: pulse-info 2s infinite; /* Hace que el bot√≥n "brille" */
}

@keyframes pulse-info {
    0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(0, 212, 255, 0.7); }
    70% { transform: scale(1.05); box-shadow: 0 0 0 10px rgba(0, 212, 255, 0); }
    100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(0, 212, 255, 0); }
}

.ex-notas-display {
    display: none;
    background: #1a1300;
    color: #ffd700; /* Dorado brillante para las notas */
    padding: 12px;
    font-size: 0.85rem;
    border: 1px dashed var(--accent);
    margin: 10px;
    border-radius: 8px;
    line-height: 1.4;
    text-align: left;
}
.ex-feedback-input {
    width: calc(100% - 20px);
    margin: 10px;
    background: #000;
    border: 1px solid #333;
    color: #888;
    padding: 8px 12px;
    border-radius: 8px;
    font-size: 0.8rem;
    outline: none;
    transition: 0.3s;
}
.ex-feedback-input:focus {
    border-color: var(--primary);
    color: white;
}
    </style>
</head>
<body>

    <header>
        <img src="icono.png" alt="Icono Leo" class="logo-header">
        <div id="display" class="timer-val" style="display: none;">00:00</div>
        <div id="alumno-header" style="text-align: right; display: none;">
            <div id="alumno-display" style="font-size: 0.8rem; color: var(--primary); font-weight: bold;">-</div>
            <div id="semana-display" style="font-size: 0.9rem; color: #ffffff; font-weight: bold; margin-top: 2px;"></div>
        </div>
    </header>

    <main id="app-container">
        <div id="welcome-screen">
            <div class="welcome-card">
                <img src="logo.png?v=2" alt="Leo Rodriguez Entrenamiento Personal" class="logo-welcome">
                <p style="font-size: 0.9rem; color: #888; margin-top: 10px;">COPI√Å EL CODIGO DE RUTINA QUE TE ENVI√â</p>
                <textarea id="code-input" placeholder="Pega el c√≥digo aqu√≠..."></textarea>
                <button class="btn-stats" onclick="cargarManual()">EMPEZAR A ENTRENAR</button>
            </div>
        </div>

        <div id="app-content" style="display:none;">
            <select id="session-picker" class="session-selector" onchange="loadSession(this.value)"></select>
            <div id="workout-content"></div>
            <button class="btn-stats" onclick="confirmarFinalizacion()">üìä GENERAR REPORTE SEMANAL</button>
            <button onclick="solicitarBorrar()" style="background:transparent; color:#444; border:none; width:100%; margin-top:40px; font-size:0.7rem; text-decoration:underline; letter-spacing: 1px;">BORRAR RUTINA ACTUAL</button>
        </div>
    </main>

    <div id="custom-confirm" class="custom-modal">
        <div class="modal-content">
            <h3 id="modal-title" style="color:white; margin-top:0; font-size:1.1rem;">¬øBorrar rutina?</h3>
            <p id="modal-text" style="color:#888; font-size:0.85rem; margin-bottom:25px;">Se eliminar√°n los pesos y series marcadas de esta semana.</p>
            <div style="display:flex; gap:10px;">
                <button id="modal-cancel-btn" onclick="cerrarConfirm(false)" style="flex:1; background:#30363d; color:white; border:none; padding:12px; border-radius:10px; font-weight:bold;">No</button>
                <button id="modal-confirm-btn" onclick="cerrarConfirm(true)" style="flex:1; background:var(--danger); color:white; border:none; padding:12px; border-radius:10px; font-weight:bold;">Confirmar</button>
            </div>
        </div>
    </div>

    <footer class="footer-sign">
    DESARROLLADO POR <a href="https://www.linkedin.com/in/nicolas-yabichino/" target="_blank"><span>NICOYABI</span></a>
</footer>

    <button id="install-banner">üì≤ INSTALAR EN MI CELULAR</button>

    <div id="hidden-canvases">
        <canvas id="chartMusculos" width="800" height="400"></canvas>
        <canvas id="chartSesiones" width="800" height="400"></canvas>
    </div>

    <script>
      // --- MOTOR DE SILENCIO (Tu c√≥digo que funciona) ---
const audioSilencio = new Audio("data:audio/wav;base64,UklGRigAAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YQQAAAAAAA==");
audioSilencio.loop = true;

let rutinaFull = {}; 
let timerInt; 
let deferredPrompt;
let endTime; 

const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

// --- TU FUNCI√ìN DE BEEP FUERTE ---
function playBeepFuerte() { 
    try { 
        let count = 0;
        const interval = setInterval(() => {
            const osc = audioCtx.createOscillator(); 
            const gain = audioCtx.createGain(); 
            osc.connect(gain); 
            gain.connect(audioCtx.destination); 
            osc.type = 'square'; 
            osc.frequency.setValueAtTime(1000, audioCtx.currentTime); 
            gain.gain.setValueAtTime(0.5, audioCtx.currentTime); 
            osc.start(); 
            osc.stop(audioCtx.currentTime + 0.2); 
            count++;
            if (count >= 4) clearInterval(interval);
        }, 300);
    } catch(e) {} 
}

        function init() { let dSaved = localStorage.getItem('routine_data_raw'); if (dSaved) procesarDatos(dSaved); }
       function cargarManual() { 
    let input = document.getElementById('code-input').value; 
    if (!input) return alert("Pega el c√≥digo"); 
    
    // ESTO DESBLOQUEA EL AUDIO EN M√ìVILES
    if (audioCtx.state === 'suspended') {
        audioCtx.resume();
    }
    
    procesarDatos(input.includes('data=') ? input.split('data=')[1] : input); 
}
        
        function procesarDatos(rawData) {
            try {
                rutinaFull = JSON.parse(decodeURIComponent(escape(atob(rawData.trim()))));
                localStorage.setItem('routine_data_raw', rawData);
                document.getElementById('alumno-display').innerText = rutinaFull.alumno;
                document.getElementById('semana-display').innerText = "SEMANA " + (rutinaFull.semana || "-");
                document.getElementById('session-picker').innerHTML = Object.keys(rutinaFull.sesiones).map(k => `<option value="${k}">${rutinaFull.sesiones[k].nombre}</option>`).join('');
                document.getElementById('welcome-screen').style.display = 'none';
                document.getElementById('app-content').style.display = 'block';
                document.getElementById('display').style.display = 'block';
                document.getElementById('alumno-header').style.display = 'block';
                loadSession(Object.keys(rutinaFull.sesiones)[0]);
            } catch (e) { alert("C√≥digo no v√°lido"); }
        }

// Array de colores para identificar sub-ejercicios (A, B, C, D...)
const coloresSS = ['#3b82f6', '#a855f7', '#22c55e', '#eab308', '#ef4444', '#06b6d4'];

function loadSession(id) {
    const s = rutinaFull.sesiones[id];
    const container = document.getElementById('workout-content');
    container.innerHTML = ""; 

    s.ejercicios.forEach((bloque, exIdx) => {
        const subEjercicios = bloque.sub_ejercicios || [bloque];
        const esSuperserie = subEjercicios.length > 1;
// L√≥gica de t√≠tulos especiales
        let tituloEspecial = "";
        if (subEjercicios.length === 2) tituloEspecial = `<div style="color:var(--accent); font-size:0.7rem; font-weight:bold; margin-bottom:8px; letter-spacing:1px;">‚ö° SUPERSERIE</div>`;
        else if (subEjercicios.length === 3) tituloEspecial = `<div style="color:#a855f7; font-size:0.7rem; font-weight:bold; margin-bottom:8px; letter-spacing:1px;">üî• TRI-SERIE</div>`;
        else if (subEjercicios.length > 3) tituloEspecial = `<div style="color:#ef4444; font-size:0.7rem; font-weight:bold; margin-bottom:8px; letter-spacing:1px;">üåÄ CIRCUITO</div>`;
        // 1. Notas √önicas
        const notasUnicas = [...new Set(subEjercicios.map(ex => ex.notas).filter(n => n && n.trim() !== ""))].join(" | ");
        const tieneNotas = notasUnicas !== "";
        const btnInfo = tieneNotas ? `<button class="info-btn" onclick="toggleNotas('${exIdx}')">‚ö†Ô∏è INDICACIONES</button>` : '';
        const divNotas = tieneNotas ? `<div id="notas-${exIdx}" class="ex-notas-display">${notasUnicas}</div>` : '';

        // 2. Cabecera con colores din√°micos por ejercicio
// 2. Cabecera con colores din√°micos (Solo muestra letras si es Superserie)
        let cabeceraEjerciciosHtml = subEjercicios.map((ex, i) => {
            const color = coloresSS[i % coloresSS.length];
            // Si es ejercicio normal, no ponemos la letra A ni el fondo
            const etiquetaLetra = esSuperserie ? 
                `<b style="color:${color}; background:rgba(255,255,255,0.08); padding:2px 6px; border-radius:4px; margin-right:5px; border:1px solid ${color}44">${String.fromCharCode(65+i)}</b>` 
                : '';

            return `
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px;">
                    <span style="font-size:0.85rem; line-height:1.2;">
                        ${etiquetaLetra}
                        <strong style="color:#fff">${ex.nombre}</strong>
                    </span>
                    ${ex.video ? `<a href="${ex.video}" target="_blank" class="yt-icon" style="font-size:0.6rem; padding:2px 5px; white-space:nowrap; margin-left:10px;">‚ñ∂ VIDEO</a>` : ''}
                </div>
            `;
        }).join("");

        const numSeries = subEjercicios[0].series;
        const savedFeedback = localStorage.getItem(`feedback_${id}_${exIdx}`) || '';

        const card = document.createElement('div');
        card.className = 'exercise-card';
        if(esSuperserie) card.style.borderLeft = `4px solid #f1c40f`; 

        // 3. Filas por Set
        let filasHtml = "";
        for(let sIdx = 0; sIdx < numSeries; sIdx++) {
            const saved = getSavedData(id, exIdx, sIdx);
            
let subFilas = subEjercicios.map((ex, subIdx) => {
                const color = coloresSS[subIdx % coloresSS.length];
                const rA = ex.reps_obj.split(',').map(x => x.trim());
                const pA = ex.peso_obj.split(',').map(x => x.trim());
                const oR = rA[sIdx] || rA[rA.length-1];
                const oK = pA[sIdx] || pA[pA.length-1];
                
                const valReps = (saved.reps || "").split("|")[subIdx] || "";
                const valPeso = (saved.peso || "").split("|")[subIdx] || "";
                const valRpe  = (saved.rpe || "").split("|")[subIdx] || "";

                // CORRECCI√ìN AQU√ç: Solo mostrar "A:", "B:", etc. si es Superserie
                const prefijoLetra = esSuperserie ? `<b style="color:${color}">${String.fromCharCode(65+subIdx)}:</b> ` : '';

                return `
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 4px; align-items: center; ${subIdx > 0 ? 'margin-top:8px; padding-top:8px; border-top:1px dashed #333;' : ''}">
                        <div class="obj-cell" style="border-color:${color}; background: ${color}11; font-size: 0.6rem;">
                            ${prefijoLetra}${oR}/${oK}
                        </div>
                        <input type="number" placeholder="R" oninput="saveDataSS('${id}',${exIdx},${sIdx},${subEjercicios.length})" value="${valReps}" inputmode="numeric">
                        <input type="number" placeholder="Kg" oninput="saveDataSS('${id}',${exIdx},${sIdx},${subEjercicios.length})" value="${valPeso}" inputmode="decimal">
                        <input type="number" placeholder="E" oninput="saveDataSS('${id}',${exIdx},${sIdx},${subEjercicios.length})" value="${valRpe}" inputmode="numeric">
                    </div>
                `;
            }).join('');

            filasHtml += `
                <div class="set-row ${saved.done ? 'done' : ''}" id="row-${exIdx}-${sIdx}" style="grid-template-columns: 25px 1fr 40px; gap:8px; padding: 10px 5px;">
                    <div style="text-align:center; font-weight:bold; color:#555; font-size:0.75rem;">${sIdx+1}</div>
                    <div>${subFilas}</div>
                    <div style="display:flex; align-items:center; justify-content:center;">
                        <button class="check-btn ${saved.done ? 'active' : ''}" onclick="markSet('${id}', ${exIdx}, ${sIdx}, ${numSeries})">‚úì</button>
                    </div>
                </div>
            `;
        }

       card.innerHTML = `
            <div style="padding:15px; background:rgba(255,255,255,0.02);">
                ${tituloEspecial}  ${cabeceraEjerciciosHtml}
                <div style="margin-top:10px;">${btnInfo}</div>
            </div>
            </div>
            ${divNotas}
            <div class="grid-header" style="grid-template-columns: 25px 1fr 40px; padding: 5px 8px;">
                <div>#</div>
                <div style="display:grid; grid-template-columns: 1fr 1fr 1fr 1fr; text-align:center; font-size:0.6rem; letter-spacing:1px;">
                    <span>OBJ</span><span>REPS</span><span>KG</span><span>RPE</span>
                </div>
                <div>OK</div>
            </div>
            ${filasHtml}
            <input type="text" class="ex-feedback-input" placeholder="Observaciones del bloque..." 
                   value="${savedFeedback}" 
                   oninput="localStorage.setItem('feedback_${id}_${exIdx}', this.value)">
        `;
        container.appendChild(card);
    });
}

function saveDataSS(sessId, exIdx, sIdx, numSubs) {
    const row = document.getElementById(`row-${exIdx}-${sIdx}`);
    const inputs = row.querySelectorAll('input:not(.ex-feedback-input)');
    const done = row.querySelector('.check-btn').classList.contains('active');
    
    let repsArr = [], pesoArr = [], rpeArr = [];
    
    for(let i=0; i < numSubs; i++) {
        // Cada bloque de ejercicio tiene 3 inputs
        repsArr.push(inputs[i*3].value || "");
        pesoArr.push(inputs[i*3 + 1].value || "");
        rpeArr.push(inputs[i*3 + 2].value || "");
    }

    localStorage.setItem(`workout_${sessId}_${exIdx}_${sIdx}`, JSON.stringify({
        reps: repsArr.join("|"), 
        peso: pesoArr.join("|"), 
        rpe: rpeArr.join("|"), 
        done: done
    }));
}
function startTimer(sec) { 
    clearInterval(timerInt); 
    const display = document.getElementById('display');
    
    // Activa el motor de silencio para evitar el bloqueo del navegador
    audioSilencio.play().catch(e => console.log("Audio iniciado"));

    endTime = Date.now() + (sec * 1000); 

    timerInt = setInterval(() => { 
        const ahora = Date.now();
        const faltan = Math.round((endTime - ahora) / 1000);

        if(faltan <= 0) { 
            clearInterval(timerInt); 
            display.innerText = "00:00";
            
            // Suena tu beep fuerte
            playBeepFuerte(); 
            
            // Pausa el silencio para ahorrar bater√≠a
            audioSilencio.pause();
            audioSilencio.currentTime = 0;
            return;
        } 

        let m = Math.floor(faltan / 60); 
        let s = faltan % 60; 
        display.innerText = `${m}:${s.toString().padStart(2,'0')}`; 
    }, 1000); 
}

        function saveData(sessId, exIdx, sIdx) { const row = document.getElementById(`row-${exIdx}-${sIdx}`); const inputs = row.querySelectorAll('input'); const done = row.querySelector('.check-btn').classList.contains('active'); localStorage.setItem(`workout_${sessId}_${exIdx}_${sIdx}`, JSON.stringify({reps: inputs[0].value, peso: inputs[1].value, rpe: inputs[2].value, done: done})); }
        function getSavedData(sessId, exIdx, sIdx) { const saved = localStorage.getItem(`workout_${sessId}_${exIdx}_${sIdx}`); return saved ? JSON.parse(saved) : { reps: '', peso: '', rpe: '', done: false }; }
function markSet(sessId, exIdx, sIdx, totalSets) { 
    const row = document.getElementById(`row-${exIdx}-${sIdx}`); 
    const btn = row.querySelector('.check-btn'); 
    row.classList.toggle('done'); 
    btn.classList.toggle('active'); 
    
    // CORRECCI√ìN AQU√ç: Detectar cu√°ntos inputs hay para usar la funci√≥n de guardado correcta
    const inputs = row.querySelectorAll('input:not(.ex-feedback-input)');
    if (inputs.length > 3) {
        saveDataSS(sessId, exIdx, sIdx, inputs.length / 3);
    } else {
        saveData(sessId, exIdx, sIdx);
    }
    
    if(row.classList.contains('done')) { 
        const sesionActual = rutinaFull.sesiones[sessId];
        const ejercicioActual = sesionActual.ejercicios[exIdx];
        const tiempoSerie = parseInt(ejercicioActual.descanso) || 90;
        const tiempoEjercicio = parseInt(ejercicioActual.descanso_final) || 120;
        const esUltimaSerie = (sIdx === totalSets - 1);
        const tiempoDescanso = esUltimaSerie ? tiempoEjercicio : tiempoSerie;
        startTimer(tiempoDescanso); 
    } 
}
        
      let modoModal = ""; // Variable para saber si estamos borrando o reportando

        function solicitarBorrar() { 
            modoModal = "BORRAR";
            document.getElementById('modal-title').innerText = "¬øBorrar rutina?";
            document.getElementById('modal-text').innerText = "Se eliminar√°n los pesos y series marcadas de esta semana.";
            document.getElementById('modal-confirm-btn').style.background = "var(--danger)";
            document.getElementById('modal-confirm-btn').innerText = "Borrar";
            document.getElementById('custom-confirm').style.display = 'flex'; 
        }

        function confirmarFinalizacion() { 
            modoModal = "REPORTE";
            document.getElementById('modal-title').innerText = "Reporte Semanal";
            document.getElementById('modal-text').innerText = "¬øDeseas generar el PDF con tu progreso de esta semana para envi√°rselo a Leo?";
            document.getElementById('modal-confirm-btn').style.background = "var(--success)";
            document.getElementById('modal-confirm-btn').innerText = "Generar";
            document.getElementById('custom-confirm').style.display = 'flex';
        }

function cerrarConfirm(aceptado) { 
            document.getElementById('custom-confirm').style.display = 'none'; 
            if(aceptado) { 
                if(modoModal === "BORRAR") {
                    localStorage.clear(); 
                    location.reload(); 
                } else if(modoModal === "REPORTE") {
                    generarReporteProfe(); 
                } else if(modoModal === "FIN") { // Nueva condici√≥n para el reinicio final
                    localStorage.clear();
                    location.reload();
                }
            } 
        }

        async function crearImgGrafico(canvasId, labels, data, maxVal, datasetLabel, tituloGrafico) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            const chart = new Chart(ctx, {
                type: 'bar', 
                data: { 
                    labels: labels, 
                    datasets: [{ 
                        label: datasetLabel, 
                        data: data, 
                        backgroundColor: '#3b82f6', 
                        borderRadius: 5,
                        barPercentage: 0.4,
                        categoryPercentage: 0.8
                    }] 
                },
                options: { 
                    animation: false, 
                    plugins: { 
                        title: { display: true, text: tituloGrafico.toUpperCase(), color: '#00d4ff', font: { size: 20, weight: 'bold' }, padding: { top: 10, bottom: 20 } },
                        legend: { display: false } 
                    }, 
                    scales: { 
                        y: { beginAtZero: true, suggestedMax: maxVal, ticks: { color: 'white', font: { size: 14 } }, grid: { color: '#333' } }, 
                        x: { ticks: { color: 'white', font: { size: 14, weight: 'bold' } }, grid: { display: false } } 
                    } 
                },
                plugins: [{
                    id: 'valueLabel',
                    afterDatasetsDraw(chart) {
                        const {ctx} = chart; ctx.save(); 
                        ctx.textAlign = 'center'; ctx.fillStyle = 'white'; ctx.font = 'bold 18px Arial'; 
                        chart.getDatasetMeta(0).data.forEach((bar, i) => {
                            ctx.fillText(chart.data.datasets[0].data[i], bar.x, bar.y - 8);
                        }); ctx.restore();
                    }
                }]
            });
            await new Promise(r => setTimeout(r, 600)); 
            const url = document.getElementById(canvasId).toDataURL('image/png'); 
            chart.destroy(); 
            return url;
        }

async function generarReporteProfe() {
    try {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('p', 'mm', 'a4');
        let cM = {}, cS = {};
        
        // 1. Procesar datos para gr√°ficos
        Object.keys(rutinaFull.sesiones).forEach(sId => {
            let tS = 0;
            rutinaFull.sesiones[sId].ejercicios.forEach((bloque, exIdx) => {
                const subEjercicios = bloque.sub_ejercicios || [bloque];
                for(let sIdx=0; sIdx < subEjercicios[0].series; sIdx++) {
                    const saved = getSavedData(sId, exIdx, sIdx);
                    if(saved.done) {
                        subEjercicios.forEach(ex => {
                            const m = (ex.grupo || "OTRO").toUpperCase();
                            cM[m] = (cM[m] || 0) + 1;
                            tS++;
                        });
                    }
                }
            });
            cS[rutinaFull.sesiones[sId].nombre] = tS;
        });

        // 2. Dise√±o de Cabecera PDF
        doc.setFillColor(0, 0, 0); doc.rect(0, 0, 210, 297, 'F');
        doc.setTextColor(255, 255, 255); doc.setFontSize(22);
        doc.text(`REPORTE SEMANA ${rutinaFull.semana || "-"}`, 105, 15, { align: 'center' });
        doc.setTextColor(0, 212, 255); doc.setFontSize(14);
        doc.text(`ALUMNO: ${rutinaFull.alumno.toUpperCase()}`, 105, 23, { align: 'center' });

        // 3. Gr√°ficos
        if (Object.keys(cM).length > 0) {
            const i1 = await crearImgGrafico('chartMusculos', Object.keys(cM), Object.values(cM), 20, 'Series', "Estimulo semanal de grupos musculares");
            doc.setDrawColor(59, 130, 246); doc.rect(12, 35, 186, 80); 
            doc.addImage(i1, 'PNG', 15, 38, 180, 74);
        }
        if (Object.keys(cS).length > 0) {
            const i2 = await crearImgGrafico('chartSesiones', Object.keys(cS), Object.values(cS), 30, 'Series', "Numero de series por entrenamiento");
            doc.setDrawColor(59, 130, 246); doc.rect(12, 125, 186, 80); 
            doc.addImage(i2, 'PNG', 15, 128, 180, 74);
        }

        // 4. Tabla de datos
        let tableBody = [];
        Object.keys(rutinaFull.sesiones).forEach(sId => {
            rutinaFull.sesiones[sId].ejercicios.forEach((bloque, exIdx) => {
                const subEjercicios = bloque.sub_ejercicios || [bloque];
                const feedback = localStorage.getItem(`feedback_${sId}_${exIdx}`) || '';

                for(let sIdx=0; sIdx < subEjercicios[0].series; sIdx++) {
                    const saved = getSavedData(sId, exIdx, sIdx);
                    if(saved.done) {
                        subEjercicios.forEach((ex, subIdx) => {
                            // Aqu√≠ est√° la correcci√≥n del SPLIT: leemos de 'ex' que siempre tiene los datos
                            const rA = (ex.reps_obj || "").toString().split(',').map(x => x.trim());
                            const pA = (ex.peso_obj || "").toString().split(',').map(x => x.trim());
                            
                            const objR = rA[sIdx] || rA[rA.length-1] || ex.reps_obj;
                            const objK = pA[sIdx] || pA[pA.length-1] || ex.peso_obj;

                            const sReps = (saved.reps || "").split("|")[subIdx] || saved.reps || "-";
                            const sPeso = (saved.peso || "").split("|")[subIdx] || saved.peso || "-";
                            const sRpe = (saved.rpe || "").split("|")[subIdx] || saved.rpe || "-";

                            const nombreAMostrar = subEjercicios.length > 1 ? `${ex.nombre} (${String.fromCharCode(65+subIdx)})` : ex.nombre;
                            const obsAMostrar = (sIdx === 0 && subIdx === 0) ? feedback : "";

                            tableBody.push([
                                nombreAMostrar, 
                                `Set ${sIdx+1}`, 
                                `${objR}R / ${objK}K`, 
                                `${sReps}R / ${sPeso}K`, 
                                sRpe,
                                obsAMostrar
                            ]);
                        });
                    }
                }
            });
        });

        if (tableBody.length > 0) {
            doc.autoTable({ 
                startY: 215, 
                head: [['EJERCICIO', 'SET', 'OBJETIVO', 'REALIZADO', 'RPE', 'OBSERVACIONES']], 
                body: tableBody, 
                theme: 'grid', 
                styles: { fillColor: [20, 20, 20], textColor: 255, fontSize: 6.5, halign: 'center' }, 
                headStyles: { fillColor: [59, 130, 246], fontSize: 7, halign: 'center' }, 
                columnStyles: { 
                    0: { halign: 'left', cellWidth: 45 },
                    5: { halign: 'left', cellWidth: 40, textColor: [234, 179, 8] }
                } 
            });
        }

        doc.save(`Reporte_${rutinaFull.alumno}_Semana${rutinaFull.semana}.pdf`);

        setTimeout(() => {
            modoModal = "FIN";
            document.getElementById('modal-title').innerText = "¬°REPORTE GENERADO!";
            document.getElementById('modal-text').innerText = "Se descarg√≥ tu progreso. La app se reiniciar√° para que puedas cargar la nueva rutina.";
            document.getElementById('modal-confirm-btn').style.background = "var(--primary)";
            document.getElementById('modal-confirm-btn').innerText = "ENTENDIDO";
            document.getElementById('modal-cancel-btn').style.display = "none";
            document.getElementById('custom-confirm').style.display = 'flex';
        }, 1500);

    } catch(e) { 
        console.error(e);
        alert("Error al generar PDF: " + e.message); 
    }
}

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            // Solo mostrar si es un dispositivo m√≥vil
            const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
            if (isMobile) {
                document.getElementById('install-banner').style.display = 'block';
            }
        });

        document.getElementById('install-banner').addEventListener('click', async () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                deferredPrompt = null;
                document.getElementById('install-banner').style.display = outcome === 'accepted' ? 'none' : 'block';
            }
        });

        init();
function toggleNotas(id) {
    const el = document.getElementById(`notas-${id}`);
    el.style.display = (el.style.display === 'block') ? 'none' : 'block';
}
    </script>
</body>
</html>

